version: "3.9"

x-configs: &common_config
  restart: always

services:
  django_admin:
    <<: *common_config
    build: ./admin
    volumes:
      - ./admin:/code
      - static_volume:/code/static
      - media_volume:/code/media
    ports:
      - "${ADMIN_PORT}:8080"
    command: /start.sh
    depends_on:
      - db
    env_file:
      - ./.env

  db:
    <<: *common_config
    image: ghcr.io/dbsystel/postgresql-partman:14
    container_name: db
    shm_size: 1g
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    env_file:
      - ./.env

  nginx:
    image: nginx:1.24
    volumes:
      - ./tmp/logs/nginx/:/var/log/nginx/
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/configs/:/etc/nginx/conf.d/:ro
      - static_volume:/data/static:ro
      - media_volume:/data/media:ro
    depends_on:
      - django_admin
    ports:
      - "80:80"

volumes:
  postgres_data:
  static_volume:
  media_volume:
